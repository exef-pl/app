<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EXEF v1.2.0</title>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <link rel="stylesheet" href="styles.css">
</head>
<body x-data="app()" x-init="init()" x-cloak>
<div class="app">
    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="logo"><span>üìÑ</span> EXEF</div>

        <!-- Profile Selector -->
        <div class="nav-group">
            <div class="nav-label">Profile</div>
            <div class="nav-item" :class="{active:view=='profiles'}" @click="navigate('profiles')">üè¢ ZarzƒÖdzanie</div>

            <div class="profile-selector" :class="{open:profileOpen}" @click="profileOpen=!profileOpen" @click.outside="profileOpen=false">
                <div class="profile-current">
                    <div class="profile-avatar" :style="{background:currentProfile?.color||'#6c5ce7'}" x-text="(currentProfile?.name||'?').substring(0,2).toUpperCase()"></div>
                    <div>
                        <div class="profile-name" x-text="currentProfile?.name||'Wybierz profil'"></div>
                        <div class="profile-nip" x-text="'NIP: '+(currentProfile?.nip||'-')"></div>
                    </div>
                </div>
                <div class="profile-dropdown">
                    <template x-for="p in profiles" :key="p.id">
                        <div class="profile-option" @click.stop="switchProfile(p.id)">
                            <div class="profile-avatar" :style="{background:p.color}" x-text="p.name.substring(0,2).toUpperCase()"></div>
                            <div>
                                <div class="profile-name" x-text="p.name"></div>
                                <div class="profile-nip" x-text="'NIP: '+p.nip"></div>
                            </div>
                        </div>
                    </template>
                    <div class="profile-option add" @click.stop="showModal='profile';profileOpen=false">‚ûï Dodaj profil</div>
                </div>
            </div>
        </div>

        <!-- Navigation -->
        <div class="nav-group">
            <div class="nav-label">Dokumenty</div>
            <div class="nav-item" :class="{active:view=='docs'}" @click="navigate('docs')">üìã ZarzƒÖdzanie <span class="badge" x-text="stats.documents?.total||0"></span></div>
            <div class="nav-item" :class="{active:view=='create'}" @click="navigate('create')">‚ú® Utw√≥rz</div>
            <div class="nav-item" :class="{active:view=='describe'}" @click="navigate('describe')">üè∑Ô∏è Opisz <span class="badge warn" x-text="stats.documents?.by_status?.created||0" x-show="stats.documents?.by_status?.created"></span></div>
            <div class="nav-item" :class="{active:view=='sign'}" @click="navigate('sign')">‚úçÔ∏è Podpisz <span class="badge warn" x-text="stats.documents?.by_status?.described||0" x-show="stats.documents?.by_status?.described"></span></div>
        </div>

        <div class="nav-group">
            <div class="nav-label">Transfer</div>
            <div class="nav-item" :class="{active:view=='upload'}" @click="navigate('upload')">üì§ Wgraj plik</div>
            <div class="nav-item" :class="{active:view=='import'}" @click="navigate('import')">üì• Import <span class="badge purple" x-text="stats.endpoints?.import||0"></span></div>
            <div class="nav-item" :class="{active:view=='export'}" @click="navigate('export')">üì§ Export <span class="badge purple" x-text="stats.endpoints?.export||0"></span></div>
            <div class="nav-item" :class="{active:view=='exportfile'}" @click="navigate('exportfile')">üìÅ Eksport pliku</div>
        </div>

        <div class="version">EXEF v1.2.0</div>
    </aside>

    <!-- Main Content -->
    <main class="main">
        <!-- Profiles View -->
        <template x-if="view=='profiles'" x-data="ProfileManager()">
            <div>
                <div class="header">
                    <h1 class="title">Profile</h1>
                    <div style="display:flex;gap:12px;align-items:center">
                        <div class="view-toggle">
                            <button :class="{active:viewMode=='cards'}" @click="toggleView('cards')">üìã Karty</button>
                            <button :class="{active:viewMode=='table'}" @click="toggleView('table')">üìä Tabela</button>
                        </div>
                        <button class="btn btn-primary" @click="createProfile()">+ Nowy profil</button>
                    </div>
                </div>

                <!-- Cards View -->
                <template x-if="viewMode=='cards'">
                    <div class="cards">
                        <template x-for="profile in profiles" :key="profile.id">
                            <div class="card">
                                <div class="card-header">
                                    <div class="card-icon" :style="{background:profile.color}" x-text="profile.name.substring(0,2).toUpperCase()"></div>
                                    <button class="btn btn-sm btn-danger" @click="deleteProfile(profile.id)" x-show="profile.id!='default'">üóë</button>
                                </div>
                                <div class="card-title" x-text="profile.name"></div>
                                <div class="card-desc" x-text="'NIP: '+profile.nip"></div>
                                <div class="card-footer">
                                    <button class="btn btn-sm btn-secondary" @click="switchProfile(profile.id)" x-show="profileId!=profile.id">Aktywuj</button>
                                    <span class="status status-signed" x-show="profileId==profile.id">Aktywny</span>
                                    <button class="btn btn-sm btn-secondary" @click="startEditProfile(profile)" title="Edytuj">‚úèÔ∏è</button>
                                </div>
                            </div>
                        </template>
                    </div>
                </template>

                <!-- Table View -->
                <template x-if="viewMode=='table'">
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th style="width:30px"></th>
                                    <th>Nazwa</th>
                                    <th>NIP</th>
                                    <th>Adres</th>
                                    <th>Uprawnienia</th>
                                    <th>Status</th>
                                    <th style="width:120px">Akcje</th>
                                </tr>
                            </thead>
                            <tbody>
                                <template x-for="profile in profiles" :key="profile.id">
                                    <!-- Profile Row -->
                                    <tr class="expandable-row" :class="{expanded: expandedRows.has(profile.id)}" @click="toggleExpand(profile.id)">
                                        <td>
                                            <span class="expand-icon" x-show="delegates[profile.id]?.length">‚ñ∂</span>
                                        </td>
                                        <td>
                                            <div style="display:flex;align-items:center;gap:8px">
                                                <div class="card-icon" style="width:24px;height:24px;font-size:10px" :style="{background:profile.color}" x-text="profile.name.substring(0,2).toUpperCase()"></div>
                                                <template x-if="editingProfile?.id == profile.id">
                                                    <input class="form-input" style="width:200px" x-model="editingProfile.name" @click.stop>
                                                </template>
                                                <template x-if="!editingProfile || editingProfile.id != profile.id">
                                                    <span class="inline-edit" x-text="profile.name"></span>
                                                </template>
                                            </div>
                                        </td>
                                        <td>
                                            <template x-if="editingProfile?.id == profile.id">
                                                <input class="form-input" style="width:120px" x-model="editingProfile.nip" @click.stop>
                                            </template>
                                            <template x-if="!editingProfile || editingProfile.id != profile.id">
                                                <span class="inline-edit" x-text="profile.nip"></span>
                                            </template>
                                        </td>
                                        <td>
                                            <template x-if="editingProfile?.id == profile.id">
                                                <input class="form-input" style="width:200px" x-model="editingProfile.address" @click.stop>
                                            </template>
                                            <template x-if="!editingProfile || editingProfile.id != profile.id">
                                                <span class="inline-edit" x-text="profile.address || '-'"></span>
                                            </template>
                                        </td>
                                        <td>
                                            <span class="badge" x-text="(delegates[profile.id] || []).length + ' os√≥b'"></span>
                                        </td>
                                        <td>
                                            <span class="status status-signed" x-show="profileId==profile.id">Aktywny</span>
                                            <span class="status status-created" x-show="profileId!=profile.id">Nieaktywny</span>
                                        </td>
                                        <td @click.stop>
                                            <template x-if="editingProfile?.id == profile.id">
                                                <button class="btn btn-sm btn-primary" @click="saveProfile()">‚úì</button>
                                                <button class="btn btn-sm btn-secondary" @click="cancelEditProfile()">‚úï</button>
                                            </template>
                                            <template x-if="!editingProfile || editingProfile.id != profile.id">
                                                <button class="btn btn-sm btn-secondary" @click="startEditProfile(profile)" title="Edytuj">‚úèÔ∏è</button>
                                                <button class="btn btn-sm btn-danger" @click="deleteProfile(profile.id)" x-show="profile.id!='default'" title="Usu≈Ñ">üóë</button>
                                            </template>
                                        </td>
                                    </tr>
                                    
                                    <!-- Delegates Sub-table -->
                                    <template x-if="expandedRows.has(profile.id) && delegates[profile.id]?.length">
                                        <tr class="expandable-content" :class="{show: expandedRows.has(profile.id)}">
                                            <td colspan="7">
                                                <div style="margin-bottom:12px;display:flex;justify-content:space-between;align-items:center">
                                                    <h4 style="margin:0;font-size:14px">üë• Uprawnienia do profilu</h4>
                                                    <button class="btn btn-sm btn-primary" @click="startEditDelegate(profile.id)">+ Dodaj osobƒô</button>
                                                </div>
                                                <table style="background:var(--bg2)">
                                                    <thead>
                                                        <tr>
                                                            <th>Osoba/Firma</th>
                                                            <th>Email</th>
                                                            <th>NIP</th>
                                                            <th>Rola</th>
                                                            <th>Status</th>
                                                            <th>Akcje</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        <template x-for="delegate in delegates[profile.id]" :key="delegate.id">
                                                            <tr>
                                                                <td>
                                                                    <template x-if="editingDelegate?.profileId == profile.id && editingDelegate?.delegate?.id == delegate.id">
                                                                        <input class="form-input" x-model="editingDelegate.delegate.delegate_name" @click.stop>
                                                                    </template>
                                                                    <template x-if="!editingDelegate || editingDelegate.profileId != profile.id || editingDelegate.delegate.id != delegate.id">
                                                                        <span x-text="delegate.delegate_name"></span>
                                                                    </template>
                                                                </td>
                                                                <td>
                                                                    <template x-if="editingDelegate?.profileId == profile.id && editingDelegate?.delegate?.id == delegate.id">
                                                                        <input class="form-input" x-model="editingDelegate.delegate.delegate_email" @click.stop>
                                                                    </template>
                                                                    <template x-if="!editingDelegate || editingDelegate.profileId != profile.id || editingDelegate.delegate.id != delegate.id">
                                                                        <span x-text="delegate.delegate_email || '-'"></span>
                                                                    </template>
                                                                </td>
                                                                <td>
                                                                    <template x-if="editingDelegate?.profileId == profile.id && editingDelegate?.delegate?.id == delegate.id">
                                                                        <input class="form-input" x-model="editingDelegate.delegate.delegate_nip" @click.stop>
                                                                    </template>
                                                                    <template x-if="!editingDelegate || editingDelegate.profileId != profile.id || editingDelegate.delegate.id != delegate.id">
                                                                        <span x-text="delegate.delegate_nip || '-'"></span>
                                                                    </template>
                                                                </td>
                                                                <td>
                                                                    <template x-if="editingDelegate?.profileId == profile.id && editingDelegate?.delegate?.id == delegate.id">
                                                                        <select class="form-input" x-model="editingDelegate.delegate.role" @click.stop>
                                                                            <option value="owner">W≈Ça≈õciciel</option>
                                                                            <option value="admin">Administrator</option>
                                                                            <option value="editor">Edytor</option>
                                                                            <option value="viewer">PodglƒÖd</option>
                                                                        </select>
                                                                    </template>
                                                                    <template x-if="!editingDelegate || editingDelegate.profileId != profile.id || editingDelegate.delegate.id != delegate.id">
                                                                        <select class="form-input" style="width:auto" :value="delegate.role" @change="saveDelegateStatus(profile.id, delegate.id, $event.target.value)">
                                                                            <option value="owner">W≈Ça≈õciciel</option>
                                                                            <option value="admin">Administrator</option>
                                                                            <option value="editor">Edytor</option>
                                                                            <option value="viewer">PodglƒÖd</option>
                                                                        </select>
                                                                    </template>
                                                                </td>
                                                                <td>
                                                                    <span class="status" :class="delegate.active ? 'status-signed' : 'status-created'" x-text="delegate.active ? 'Aktywny' : 'Nieaktywny'"></span>
                                                                </td>
                                                                <td>
                                                                    <template x-if="editingDelegate?.profileId == profile.id && editingDelegate?.delegate?.id == delegate.id">
                                                                        <button class="btn btn-sm btn-primary" @click="saveDelegate()">‚úì</button>
                                                                        <button class="btn btn-sm btn-secondary" @click="cancelEditDelegate()">‚úï</button>
                                                                    </template>
                                                                    <template x-if="!editingDelegate || editingDelegate.profileId != profile.id || editingDelegate.delegate.id != delegate.id">
                                                                        <button class="btn btn-sm btn-secondary" @click="toggleDelegateStatus(profile.id, delegate)" x-text="delegate.active ? 'Dezaktywuj' : 'Aktywuj'"></button>
                                                                        <button class="btn btn-sm btn-danger" @click="deleteDelegate(profile.id, delegate.id)">üóë</button>
                                                                    </template>
                                                                </td>
                                                            </tr>
                                                        </template>
                                                        
                                                        <!-- Add new delegate row -->
                                                        <template x-if="editingDelegate?.profileId == profile.id && !editingDelegate.delegate.id">
                                                            <tr style="background:var(--bg3)">
                                                                <td><input class="form-input" x-model="editingDelegate.delegate.delegate_name" placeholder="Nazwa" @click.stop></td>
                                                                <td><input class="form-input" x-model="editingDelegate.delegate.delegate_email" placeholder="Email" @click.stop></td>
                                                                <td><input class="form-input" x-model="editingDelegate.delegate.delegate_nip" placeholder="NIP" @click.stop></td>
                                                                <td>
                                                                    <select class="form-input" x-model="editingDelegate.delegate.role" @click.stop>
                                                                        <option value="viewer">PodglƒÖd</option>
                                                                        <option value="editor">Edytor</option>
                                                                        <option value="admin">Administrator</option>
                                                                        <option value="owner">W≈Ça≈õciciel</option>
                                                                    </select>
                                                                </td>
                                                                <td colspan="2">
                                                                    <button class="btn btn-sm btn-primary" @click="saveDelegate()">Dodaj</button>
                                                                    <button class="btn btn-sm btn-secondary" @click="cancelEditDelegate()">Anuluj</button>
                                                                </td>
                                                            </tr>
                                                        </template>
                                                    </tbody>
                                                </table>
                                            </td>
                                        </tr>
                                    </template>
                                </template>
                            </tbody>
                        </table>
                    </div>
                </template>
            </div>
        </template>

        <!-- Documents View -->
        <template x-if="view=='docs'" x-data="DocumentManager()">
            <div>
                <div class="header">
                    <h1 class="title">Dokumenty</h1>
                    <div style="display:flex;gap:12px;align-items:center">
                        <div class="view-toggle">
                            <button :class="{active:viewMode=='table'}" @click="toggleView('table')">üìä Tabela</button>
                            <button :class="{active:viewMode=='cards'}" @click="toggleView('cards')">üìã Karty</button>
                        </div>
                        <button class="btn btn-primary" @click="navigate('create')">+ Nowy dokument</button>
                    </div>
                </div>

                <!-- Filters -->
                <div class="card" style="margin-bottom:16px">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Szukaj</label>
                            <input class="form-input" placeholder="Numer lub kontrahent" x-model="filters.search" @input="loadDocuments()">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Status</label>
                            <select class="form-input" x-model="filters.status" @change="loadDocuments()">
                                <option value="">Wszystkie</option>
                                <option value="created">Utworzone</option>
                                <option value="described">Opisane</option>
                                <option value="signed">Podpisane</option>
                                <option value="exported">Wyeksportowane</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Typ</label>
                            <select class="form-input" x-model="filters.type" @change="loadDocuments()">
                                <option value="">Wszystkie</option>
                                <option value="invoice">Faktura</option>
                                <option value="contract">Umowa</option>
                                <option value="payment">P≈Çatno≈õƒá</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Bulk Actions -->
                <div class="card" style="margin-bottom:16px" x-show="selectedDocuments.size">
                    <div style="display:flex;gap:8px;align-items:center">
                        <span x-text="`Wybrano: ${selectedDocuments.size}`"></span>
                        <button class="btn btn-sm btn-secondary" @click="bulkUpdateStatus('described')">Opisz</button>
                        <button class="btn btn-sm btn-secondary" @click="bulkUpdateStatus('signed')">Podpisz</button>
                        <button class="btn btn-sm btn-danger" @click="selectedDocuments.clear()">Wyczy≈õƒá</button>
                    </div>
                </div>

                <!-- Table View -->
                <template x-if="viewMode=='table'">
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th style="width:30px">
                                        <input type="checkbox" @change="selectAll()" :checked="selectedDocuments.size == documents.length">
                                    </th>
                                    <th>Numer</th>
                                    <th>Typ</th>
                                    <th>Kontrahent</th>
                                    <th>Kwota</th>
                                    <th>VAT</th>
                                    <th>Status</th>
                                    <th style="width:120px">Akcje</th>
                                </tr>
                            </thead>
                            <tbody>
                                <template x-for="doc in filteredDocuments()" :key="doc.id">
                                    <tr>
                                        <td>
                                            <input type="checkbox" :checked="selectedDocuments.has(doc.id)" @change="toggleSelection(doc.id)">
                                        </td>
                                        <td>
                                            <template x-if="editingDocument?.id == doc.id">
                                                <input class="form-input" x-model="editingDocument.number" @click.stop>
                                            </template>
                                            <template x-if="!editingDocument || editingDocument.id != doc.id">
                                                <span class="inline-edit" x-text="doc.number" @click="navigate('doc', {id: doc.id})"></span>
                                            </template>
                                        </td>
                                        <td x-text="doc.type"></td>
                                        <td>
                                            <template x-if="editingDocument?.id == doc.id">
                                                <input class="form-input" x-model="editingDocument.contractor" @click.stop>
                                            </template>
                                            <template x-if="!editingDocument || editingDocument.id != doc.id">
                                                <span class="inline-edit" x-text="doc.contractor"></span>
                                            </template>
                                        </td>
                                        <td>
                                            <template x-if="editingDocument?.id == doc.id">
                                                <input class="form-input" type="number" x-model="editingDocument.amount" @click.stop>
                                            </template>
                                            <template x-if="!editingDocument || editingDocument.id != doc.id">
                                                <span x-text="doc.amount + ' PLN'"></span>
                                            </template>
                                        </td>
                                        <td x-text="doc.vat_rate"></td>
                                        <td>
                                            <span class="status" :class="'status-'+doc.status" x-text="doc.status"></span>
                                        </td>
                                        <td>
                                            <template x-if="editingDocument?.id == doc.id">
                                                <button class="btn btn-sm btn-primary" @click="saveDocument()">‚úì</button>
                                                <button class="btn btn-sm btn-secondary" @click="cancelEditDocument()">‚úï</button>
                                            </template>
                                            <template x-if="!editingDocument || editingDocument.id != doc.id">
                                                <button class="btn btn-sm btn-secondary" @click="startEditDocument(doc)" title="Edytuj">‚úèÔ∏è</button>
                                                <button class="btn btn-sm btn-danger" @click="deleteDocument(doc.id)" title="Usu≈Ñ">üóë</button>
                                            </template>
                                        </td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>
                </template>

                <!-- Cards View -->
                <template x-if="viewMode=='cards'">
                    <div class="cards">
                        <template x-for="doc in filteredDocuments()" :key="doc.id">
                            <div class="card">
                                <div class="card-header">
                                    <div class="card-icon" :style="{background:doc.type=='invoice'?'linear-gradient(135deg,#00d4aa,#00b894)':doc.type=='contract'?'linear-gradient(135deg,#fdcb6e,#f39c12)':'linear-gradient(135deg,#74b9ff,#0984e3)'}" x-text="doc.type=='invoice'?'üßæ':doc.type=='contract'?'üìÑ':'üí≥'"></div>
                                    <span class="status" :class="'status-'+doc.status" x-text="doc.status"></span>
                                </div>
                                <div class="card-title" x-text="doc.number"></div>
                                <div class="card-desc" x-text="doc.contractor"></div>
                                <div class="card-stats">
                                    <div>
                                        <div class="stat-value" x-text="doc.amount + ' PLN'"></div>
                                        <div class="stat-label">Kwota</div>
                                    </div>
                                    <div>
                                        <div class="stat-value" x-text="doc.vat_rate"></div>
                                        <div class="stat-label">VAT</div>
                                    </div>
                                </div>
                                <div class="card-footer">
                                    <button class="btn btn-sm btn-secondary" @click="startEditDocument(doc)">Edytuj</button>
                                    <button class="btn btn-sm btn-danger" @click="deleteDocument(doc.id)">üóë</button>
                                </div>
                            </div>
                        </template>
                    </div>
                </template>
            </div>
        </template>

        <!-- Other views (simplified) -->
        <template x-if="!['profiles', 'docs'].includes(view)">
            <div class="header">
                <h1 class="title" x-text="viewTitle(view)"></h1>
            </div>
            <div class="card">
                <div class="empty">Widok w przygotowaniu...</div>
            </div>
        </template>
    </main>
</div>

<!-- Toast -->
<div class="toast" x-show="toast" x-text="toast" x-transition x-init="$watch('toast',v=>{if(v)setTimeout(()=>toast='',3000)})"></div>

<!-- Scripts -->
<script src="router.js"></script>
<script src="components/profile-manager.js"></script>
<script src="components/document-manager.js"></script>
<script>
    function app() {
        return {
            view: new URLSearchParams(window.location.search).get('view') || 'profiles',
            docId: new URLSearchParams(window.location.search).get('id'),
            profileId: localStorage.getItem('exef_profile') || 'default',
            profileOpen: false,
            profiles: [],
            documents: [],
            endpoints: [],
            stats: {},
            toast: '',
            
            get currentProfile() { 
                return this.profiles.find(p => p.id === this.profileId) 
            },
            
            async init() {
                await this.loadProfiles();
                this.restoreFromURL();
                window.addEventListener('popstate', () => this.restoreFromURL());
                await this.load();
                this.connectWS();
                
                // Listen for toast events
                window.addEventListener('toast', (e) => {
                    this.toast = e.detail;
                });
            },
            
            navigate(view, params = {}) {
                this.view = view;
                this.docId = params.id || null;
                this.updateURL();
            },
            
            updateURL() {
                const url = new URL(window.location);
                url.searchParams.set('view', this.view);
                url.searchParams.set('profile', this.profileId);
                if (this.docId) {
                    url.searchParams.set('id', this.docId);
                } else {
                    url.searchParams.delete('id');
                }
                window.history.pushState({view: this.view, profile: this.profileId, id: this.docId}, '', url);
            },
            
            restoreFromURL() {
                const params = new URLSearchParams(window.location.search);
                const view = params.get('view');
                const profile = params.get('profile');
                const id = params.get('id');
                
                if (view) this.view = view;
                if (id) this.docId = id;
                if (profile) {
                    this.profileId = profile;
                }
            },
            
            async loadProfiles() {
                const response = await fetch('/api/profiles');
                this.profiles = await response.json();
                if (!this.profiles.find(p => p.id === this.profileId)) {
                    this.profileId = this.profiles[0]?.id || 'default';
                }
            },
            
            async load() {
                try {
                    const [docs, eps, stats] = await Promise.all([
                        fetch(`/api/profiles/${this.profileId}/documents`).then(r => r.ok ? r.json() : []),
                        fetch(`/api/profiles/${this.profileId}/endpoints`).then(r => r.ok ? r.json() : []),
                        fetch(`/api/profiles/${this.profileId}/stats`).then(r => r.ok ? r.json() : {})
                    ]);
                    this.documents = docs;
                    this.endpoints = eps;
                    this.stats = stats;
                } catch (e) {
                    console.error('Load error:', e);
                }
            },
            
            async switchProfile(id) {
                this.profileId = id;
                this.profileOpen = false;
                this.updateURL();
                await this.load();
                this.reconnectWS();
            },
            
            connectWS() {
                const proto = location.protocol === 'https:' ? 'wss:' : 'ws:';
                this.ws = new WebSocket(`${proto}//${location.host}/ws/${this.profileId}`);
                this.ws.onmessage = (e) => { this.toast = JSON.parse(e.data).event; this.load(); };
                this.ws.onclose = () => setTimeout(() => this.connectWS(), 2000);
            },
            
            reconnectWS() {
                if (this.ws) this.ws.close();
                this.connectWS();
            },
            
            viewTitle(view) {
                const titles = {
                    'docs': 'Dokumenty',
                    'create': 'Utw√≥rz dokument',
                    'describe': 'Opis i kategoryzacja',
                    'sign': 'Podpis dokument√≥w',
                    'upload': 'Wgraj plik',
                    'import': 'Import',
                    'export': 'Export',
                    'exportfile': 'Eksport do pliku'
                };
                return titles[view] || view;
            }
        };
    }
    
    // Initialize global app instance
    document.addEventListener('alpine:init', () => {
        window.appInstance = Alpine.data('app', app);
    });
</script>
</body>
</html>
