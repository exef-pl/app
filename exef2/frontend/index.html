<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EXEF v1.2.0</title>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <link rel="stylesheet" href="styles.css">
</head>
<body x-data="app()" x-init="init()" x-cloak>
<div class="app">
    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="logo"><span>üìÑ</span> EXEF</div>

        <!-- Profile Selector -->
        <div class="nav-group">
            <div class="nav-label">Profile</div>
            <div class="nav-item" :class="{active:view=='profiles'}" @click="navigate('profiles')">üè¢ ZarzƒÖdzanie</div>

            <div class="profile-selector" :class="{open:profileOpen}" @click="profileOpen=!profileOpen" @click.outside="profileOpen=false">
                <div class="profile-current">
                    <div class="profile-avatar" :style="{background:currentProfile?.color||'#6c5ce7'}" x-text="(currentProfile?.name||'?').substring(0,2).toUpperCase()"></div>
                    <div>
                        <div class="profile-name" x-text="currentProfile?.name||'Wybierz profil'"></div>
                        <div class="profile-nip" x-text="'NIP: '+(currentProfile?.nip||'-')"></div>
                    </div>
                </div>
                <div class="profile-dropdown">
                    <template x-for="p in profiles" :key="p.id">
                        <div class="profile-option" @click.stop="switchProfile(p.id)">
                            <div class="profile-avatar" :style="{background:p.color}" x-text="p.name.substring(0,2).toUpperCase()"></div>
                            <div>
                                <div class="profile-name" x-text="p.name"></div>
                                <div class="profile-nip" x-text="'NIP: '+p.nip"></div>
                            </div>
                        </div>
                    </template>
                    <div class="profile-option add" @click.stop="profileOpen=false; navigate('profiles')">‚ûï Dodaj profil</div>
                </div>
            </div>
        </div>

        <!-- Navigation -->
        <div class="nav-group">
            <div class="nav-label">Dokumenty</div>
            <div class="nav-item" :class="{active:view=='docs'}" @click="navigate('docs')">üìã ZarzƒÖdzanie <span class="badge" x-text="stats.documents?.total||0"></span></div>
            <div class="nav-item" :class="{active:view=='create'}" @click="navigate('create')">‚ú® Utw√≥rz</div>
            <div class="nav-item" :class="{active:view=='describe'}" @click="navigate('describe')">üè∑Ô∏è Opisz <span class="badge warn" x-text="stats.documents?.by_status?.created||0" x-show="stats.documents?.by_status?.created"></span></div>
            <div class="nav-item" :class="{active:view=='sign'}" @click="navigate('sign')">‚úçÔ∏è Podpisz <span class="badge warn" x-text="stats.documents?.by_status?.described||0" x-show="stats.documents?.by_status?.described"></span></div>
        </div>

        <div class="nav-group">
            <div class="nav-label">Transfer</div>
            <div class="nav-item" :class="{active:view=='upload'}" @click="navigate('upload')">üì§ Wgraj plik</div>
            <div class="nav-item" :class="{active:view=='import'}" @click="navigate('import')">üì• Import <span class="badge purple" x-text="stats.endpoints?.import||0"></span></div>
            <div class="nav-item" :class="{active:view=='export'}" @click="navigate('export')">üì§ Export <span class="badge purple" x-text="stats.endpoints?.export||0"></span></div>
            <div class="nav-item" :class="{active:view=='exportfile'}" @click="navigate('exportfile')">üìÅ Eksport pliku</div>
        </div>

        <div class="version">EXEF v1.2.0</div>
    </aside>

    <!-- Main Content -->
    <main class="main">
        <!-- Profiles View -->
        <template x-if="view=='profiles'" x-data="ProfileManager()" x-init="init(profileId)">
            <div>
                <div class="header">
                    <h1 class="title">Profile</h1>
                    <div style="display:flex;gap:12px;align-items:center">
                        <div class="view-toggle">
                            <button :class="{active:viewMode=='cards'}" @click="toggleView('cards')">üìã Karty</button>
                            <button :class="{active:viewMode=='table'}" @click="toggleView('table')">üìä Tabela</button>
                        </div>
                        <button class="btn btn-primary" @click="createProfile()">+ Nowy profil</button>
                    </div>
                </div>

                <!-- Cards View -->
                <template x-if="viewMode=='cards'">
                    <div class="cards">
                        <template x-for="profile in profiles" :key="profile.id">
                            <div class="card">
                                <div class="card-header">
                                    <div class="card-icon" :style="{background:profile.color}" x-text="profile.name.substring(0,2).toUpperCase()"></div>
                                    <button class="btn btn-sm btn-danger" @click="deleteProfile(profile.id)" x-show="profile.id!='default'">üóë</button>
                                </div>
                                <div class="card-title" x-text="profile.name"></div>
                                <div class="card-desc" x-text="'NIP: '+profile.nip"></div>
                                <div class="card-footer">
                                    <button class="btn btn-sm btn-secondary" @click="switchProfile(profile.id)" x-show="profileId!=profile.id">Aktywuj</button>
                                    <span class="status status-signed" x-show="profileId==profile.id">Aktywny</span>
                                    <button class="btn btn-sm btn-secondary" @click="startEditProfile(profile)" title="Edytuj">‚úèÔ∏è</button>
                                </div>
                            </div>
                        </template>
                    </div>
                </template>

                <!-- Table View -->
                <template x-if="viewMode=='table'">
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th style="width:30px"></th>
                                    <th>Nazwa</th>
                                    <th>NIP</th>
                                    <th>Adres</th>
                                    <th>Uprawnienia</th>
                                    <th>Status</th>
                                    <th style="width:120px">Akcje</th>
                                </tr>
                            </thead>
                            <tbody>
                                <template x-for="profile in profiles" :key="profile.id">
                                    <!-- Profile Row -->
                                    <tr class="expandable-row" :class="{expanded: expandedRows.has(profile.id)}" @click="toggleExpand(profile.id)">
                                        <td>
                                            <span class="expand-icon" x-show="delegates[profile.id]?.length">‚ñ∂</span>
                                        </td>
                                        <td>
                                            <div style="display:flex;align-items:center;gap:8px">
                                                <div class="card-icon" style="width:24px;height:24px;font-size:10px" :style="{background:profile.color}" x-text="profile.name.substring(0,2).toUpperCase()"></div>
                                                <template x-if="editingProfile?.id == profile.id">
                                                    <input class="form-input" style="width:200px" x-model="editingProfile.name" @click.stop>
                                                </template>
                                                <template x-if="!editingProfile || editingProfile.id != profile.id">
                                                    <span class="inline-edit" x-text="profile.name"></span>
                                                </template>
                                            </div>
                                        </td>
                                        <td>
                                            <template x-if="editingProfile?.id == profile.id">
                                                <input class="form-input" style="width:120px" x-model="editingProfile.nip" @click.stop>
                                            </template>
                                            <template x-if="!editingProfile || editingProfile.id != profile.id">
                                                <span class="inline-edit" x-text="profile.nip"></span>
                                            </template>
                                        </td>
                                        <td>
                                            <template x-if="editingProfile?.id == profile.id">
                                                <input class="form-input" style="width:200px" x-model="editingProfile.address" @click.stop>
                                            </template>
                                            <template x-if="!editingProfile || editingProfile.id != profile.id">
                                                <span class="inline-edit" x-text="profile.address || '-'"></span>
                                            </template>
                                        </td>
                                        <td>
                                            <span class="badge" x-text="(delegates[profile.id] || []).length + ' os√≥b'"></span>
                                        </td>
                                        <td>
                                            <span class="status status-signed" x-show="profileId==profile.id">Aktywny</span>
                                            <span class="status status-created" x-show="profileId!=profile.id">Nieaktywny</span>
                                        </td>
                                        <td @click.stop>
                                            <template x-if="editingProfile?.id == profile.id">
                                                <button class="btn btn-sm btn-primary" @click="saveProfile()">‚úì</button>
                                                <button class="btn btn-sm btn-secondary" @click="cancelEditProfile()">‚úï</button>
                                            </template>
                                            <template x-if="!editingProfile || editingProfile.id != profile.id">
                                                <button class="btn btn-sm btn-secondary" @click="startEditProfile(profile)" title="Edytuj">‚úèÔ∏è</button>
                                                <button class="btn btn-sm btn-danger" @click="deleteProfile(profile.id)" x-show="profile.id!='default'" title="Usu≈Ñ">üóë</button>
                                            </template>
                                        </td>
                                    </tr>
                                    
                                    <!-- Delegates Sub-table -->
                                    <template x-if="expandedRows.has(profile.id) && delegates[profile.id]?.length">
                                        <tr class="expandable-content" :class="{show: expandedRows.has(profile.id)}">
                                            <td colspan="7">
                                                <div style="margin-bottom:12px;display:flex;justify-content:space-between;align-items:center">
                                                    <h4 style="margin:0;font-size:14px">üë• Uprawnienia do profilu</h4>
                                                    <button class="btn btn-sm btn-primary" @click="startEditDelegate(profile.id)">+ Dodaj osobƒô</button>
                                                </div>
                                                <table style="background:var(--bg2)">
                                                    <thead>
                                                        <tr>
                                                            <th>Osoba/Firma</th>
                                                            <th>Email</th>
                                                            <th>NIP</th>
                                                            <th>Rola</th>
                                                            <th>Status</th>
                                                            <th>Akcje</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        <template x-for="delegate in delegates[profile.id]" :key="delegate.id">
                                                            <tr>
                                                                <td>
                                                                    <template x-if="editingDelegate?.profileId == profile.id && editingDelegate?.delegate?.id == delegate.id">
                                                                        <input class="form-input" x-model="editingDelegate.delegate.delegate_name" @click.stop>
                                                                    </template>
                                                                    <template x-if="!editingDelegate || editingDelegate.profileId != profile.id || editingDelegate.delegate.id != delegate.id">
                                                                        <span x-text="delegate.delegate_name"></span>
                                                                    </template>
                                                                </td>
                                                                <td>
                                                                    <template x-if="editingDelegate?.profileId == profile.id && editingDelegate?.delegate?.id == delegate.id">
                                                                        <input class="form-input" x-model="editingDelegate.delegate.delegate_email" @click.stop>
                                                                    </template>
                                                                    <template x-if="!editingDelegate || editingDelegate.profileId != profile.id || editingDelegate.delegate.id != delegate.id">
                                                                        <span x-text="delegate.delegate_email || '-'"></span>
                                                                    </template>
                                                                </td>
                                                                <td>
                                                                    <template x-if="editingDelegate?.profileId == profile.id && editingDelegate?.delegate?.id == delegate.id">
                                                                        <input class="form-input" x-model="editingDelegate.delegate.delegate_nip" @click.stop>
                                                                    </template>
                                                                    <template x-if="!editingDelegate || editingDelegate.profileId != profile.id || editingDelegate.delegate.id != delegate.id">
                                                                        <span x-text="delegate.delegate_nip || '-'"></span>
                                                                    </template>
                                                                </td>
                                                                <td>
                                                                    <template x-if="editingDelegate?.profileId == profile.id && editingDelegate?.delegate?.id == delegate.id">
                                                                        <select class="form-input" x-model="editingDelegate.delegate.role" @click.stop>
                                                                            <option value="owner">W≈Ça≈õciciel</option>
                                                                            <option value="admin">Administrator</option>
                                                                            <option value="editor">Edytor</option>
                                                                            <option value="viewer">PodglƒÖd</option>
                                                                        </select>
                                                                    </template>
                                                                    <template x-if="!editingDelegate || editingDelegate.profileId != profile.id || editingDelegate.delegate.id != delegate.id">
                                                                        <select class="form-input" style="width:auto" :value="delegate.role" @change="saveDelegateStatus(profile.id, delegate.id, $event.target.value)">
                                                                            <option value="owner">W≈Ça≈õciciel</option>
                                                                            <option value="admin">Administrator</option>
                                                                            <option value="editor">Edytor</option>
                                                                            <option value="viewer">PodglƒÖd</option>
                                                                        </select>
                                                                    </template>
                                                                </td>
                                                                <td>
                                                                    <span class="status" :class="delegate.active ? 'status-signed' : 'status-created'" x-text="delegate.active ? 'Aktywny' : 'Nieaktywny'"></span>
                                                                </td>
                                                                <td>
                                                                    <template x-if="editingDelegate?.profileId == profile.id && editingDelegate?.delegate?.id == delegate.id">
                                                                        <button class="btn btn-sm btn-primary" @click="saveDelegate()">‚úì</button>
                                                                        <button class="btn btn-sm btn-secondary" @click="cancelEditDelegate()">‚úï</button>
                                                                    </template>
                                                                    <template x-if="!editingDelegate || editingDelegate.profileId != profile.id || editingDelegate.delegate.id != delegate.id">
                                                                        <button class="btn btn-sm btn-secondary" @click="toggleDelegateStatus(profile.id, delegate)" x-text="delegate.active ? 'Dezaktywuj' : 'Aktywuj'"></button>
                                                                        <button class="btn btn-sm btn-danger" @click="deleteDelegate(profile.id, delegate.id)">üóë</button>
                                                                    </template>
                                                                </td>
                                                            </tr>
                                                        </template>
                                                        
                                                        <!-- Add new delegate row -->
                                                        <template x-if="editingDelegate?.profileId == profile.id && !editingDelegate.delegate.id">
                                                            <tr style="background:var(--bg3)">
                                                                <td><input class="form-input" x-model="editingDelegate.delegate.delegate_name" placeholder="Nazwa" @click.stop></td>
                                                                <td><input class="form-input" x-model="editingDelegate.delegate.delegate_email" placeholder="Email" @click.stop></td>
                                                                <td><input class="form-input" x-model="editingDelegate.delegate.delegate_nip" placeholder="NIP" @click.stop></td>
                                                                <td>
                                                                    <select class="form-input" x-model="editingDelegate.delegate.role" @click.stop>
                                                                        <option value="viewer">PodglƒÖd</option>
                                                                        <option value="editor">Edytor</option>
                                                                        <option value="admin">Administrator</option>
                                                                        <option value="owner">W≈Ça≈õciciel</option>
                                                                    </select>
                                                                </td>
                                                                <td colspan="2">
                                                                    <button class="btn btn-sm btn-primary" @click="saveDelegate()">Dodaj</button>
                                                                    <button class="btn btn-sm btn-secondary" @click="cancelEditDelegate()">Anuluj</button>
                                                                </td>
                                                            </tr>
                                                        </template>
                                                    </tbody>
                                                </table>
                                            </td>
                                        </tr>
                                    </template>
                                </template>
                            </tbody>
                        </table>
                    </div>
                </template>
            </div>
        </template>

        <!-- Documents View -->
        <template x-if="view=='docs'" x-data="DocumentManager()" x-init="init(profileId)">
            <div>
                <div class="header">
                    <h1 class="title">Dokumenty</h1>
                    <div style="display:flex;gap:12px;align-items:center">
                        <div class="view-toggle">
                            <button :class="{active:viewMode=='table'}" @click="toggleView('table')">üìä Tabela</button>
                            <button :class="{active:viewMode=='cards'}" @click="toggleView('cards')">üìã Karty</button>
                        </div>
                        <button class="btn btn-primary" @click="navigate('create')">+ Nowy dokument</button>
                    </div>
                </div>

                <!-- Filters -->
                <div class="card" style="margin-bottom:16px">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Szukaj</label>
                            <input class="form-input" placeholder="Numer lub kontrahent" x-model="filters.search" @input="loadDocuments()">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Status</label>
                            <select class="form-input" x-model="filters.status" @change="loadDocuments()">
                                <option value="">Wszystkie</option>
                                <option value="created">Utworzone</option>
                                <option value="described">Opisane</option>
                                <option value="signed">Podpisane</option>
                                <option value="exported">Wyeksportowane</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Typ</label>
                            <select class="form-input" x-model="filters.type" @change="loadDocuments()">
                                <option value="">Wszystkie</option>
                                <option value="invoice">Faktura</option>
                                <option value="contract">Umowa</option>
                                <option value="payment">P≈Çatno≈õƒá</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Bulk Actions -->
                <div class="card" style="margin-bottom:16px" x-show="selectedDocuments.size">
                    <div style="display:flex;gap:8px;align-items:center">
                        <span x-text="`Wybrano: ${selectedDocuments.size}`"></span>
                        <button class="btn btn-sm btn-secondary" @click="bulkUpdateStatus('described')">Opisz</button>
                        <button class="btn btn-sm btn-primary" @click="openSignatureView()">üîê Podpis elektroniczny</button>
                        <button class="btn btn-sm btn-danger" @click="selectedDocuments.clear()">Wyczy≈õƒá</button>
                    </div>
                </div>

                <!-- Table View -->
                <template x-if="viewMode=='table'">
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th style="width:30px">
                                        <input type="checkbox" @change="selectAll()" :checked="selectedDocuments.size == documents.length">
                                    </th>
                                    <th>Numer</th>
                                    <th>Typ</th>
                                    <th>Kontrahent</th>
                                    <th>Kwota</th>
                                    <th>VAT</th>
                                    <th>Status</th>
                                    <th style="width:120px">Akcje</th>
                                </tr>
                            </thead>
                            <tbody>
                                <template x-for="doc in filteredDocuments()" :key="doc.id">
                                    <tr>
                                        <td>
                                            <input type="checkbox" :checked="selectedDocuments.has(doc.id)" @change="toggleSelection(doc.id)">
                                        </td>
                                        <td>
                                            <template x-if="editingDocument?.id == doc.id">
                                                <input class="form-input" x-model="editingDocument.number" @click.stop>
                                            </template>
                                            <template x-if="!editingDocument || editingDocument.id != doc.id">
                                                <span class="inline-edit" x-text="doc.number" @click="navigate('doc', {id: doc.id})"></span>
                                            </template>
                                        </td>
                                        <td x-text="doc.type"></td>
                                        <td>
                                            <template x-if="editingDocument?.id == doc.id">
                                                <input class="form-input" x-model="editingDocument.contractor" @click.stop>
                                            </template>
                                            <template x-if="!editingDocument || editingDocument.id != doc.id">
                                                <span class="inline-edit" x-text="doc.contractor"></span>
                                            </template>
                                        </td>
                                        <td>
                                            <template x-if="editingDocument?.id == doc.id">
                                                <input class="form-input" type="number" x-model="editingDocument.amount" @click.stop>
                                            </template>
                                            <template x-if="!editingDocument || editingDocument.id != doc.id">
                                                <span x-text="doc.amount + ' PLN'"></span>
                                            </template>
                                        </td>
                                        <td x-text="doc.vat_rate"></td>
                                        <td>
                                            <span class="status" :class="'status-'+doc.status" x-text="doc.status"></span>
                                        </td>
                                        <td>
                                            <template x-if="editingDocument?.id == doc.id">
                                                <button class="btn btn-sm btn-primary" @click="saveDocument()">‚úì</button>
                                                <button class="btn btn-sm btn-secondary" @click="cancelEditDocument()">‚úï</button>
                                            </template>
                                            <template x-if="!editingDocument || editingDocument.id != doc.id">
                                                <button class="btn btn-sm btn-secondary" @click="startEditDocument(doc)" title="Edytuj">‚úèÔ∏è</button>
                                                <button class="btn btn-sm btn-danger" @click="deleteDocument(doc.id)" title="Usu≈Ñ">üóë</button>
                                            </template>
                                        </td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>
                </template>

                <!-- Cards View -->
                <template x-if="viewMode=='cards'">
                    <div class="cards">
                        <template x-for="doc in filteredDocuments()" :key="doc.id">
                            <div class="card">
                                <div class="card-header">
                                    <div class="card-icon" :style="{background:doc.type=='invoice'?'linear-gradient(135deg,#00d4aa,#00b894)':doc.type=='contract'?'linear-gradient(135deg,#fdcb6e,#f39c12)':'linear-gradient(135deg,#74b9ff,#0984e3)'}" x-text="doc.type=='invoice'?'üßæ':doc.type=='contract'?'üìÑ':'üí≥'"></div>
                                    <span class="status" :class="'status-'+doc.status" x-text="doc.status"></span>
                                </div>
                                <div class="card-title" x-text="doc.number"></div>
                                <div class="card-desc" x-text="doc.contractor"></div>
                                <div class="card-stats">
                                    <div>
                                        <div class="stat-value" x-text="doc.amount + ' PLN'"></div>
                                        <div class="stat-label">Kwota</div>
                                    </div>
                                    <div>
                                        <div class="stat-value" x-text="doc.vat_rate"></div>
                                        <div class="stat-label">VAT</div>
                                    </div>
                                </div>
                                <div class="card-footer">
                                    <button class="btn btn-sm btn-secondary" @click="startEditDocument(doc)">Edytuj</button>
                                    <button class="btn btn-sm btn-danger" @click="deleteDocument(doc.id)">üóë</button>
                                </div>
                            </div>
                        </template>
                    </div>
                </template>
            </div>
        </template>

        <!-- Create Document View -->
        <template x-if="view=='create'">
            <div x-init="ensureNewDoc()">
                <div class="header">
                    <h1 class="title">Utw√≥rz dokument</h1>
                </div>
                <div class="card" style="max-width:480px">
                    <div class="form-group">
                        <label class="form-label">Typ</label>
                        <select class="form-input" x-model="newDoc.type">
                            <option value="invoice">Faktura</option>
                            <option value="contract">Umowa</option>
                            <option value="payment">P≈Çatno≈õƒá</option>
                        </select>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Numer</label>
                            <input class="form-input" x-model="newDoc.number" placeholder="FV/2026/01/001">
                        </div>
                        <div class="form-group">
                            <label class="form-label">VAT</label>
                            <select class="form-input" x-model="newDoc.vat_rate">
                                <option value="23%">23%</option>
                                <option value="8%">8%</option>
                                <option value="5%">5%</option>
                                <option value="0%">0%</option>
                                <option value="ZW">ZW</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Kontrahent</label>
                        <input class="form-input" x-model="newDoc.contractor" placeholder="Nazwa firmy">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Kwota netto</label>
                        <input class="form-input" type="number" x-model="newDoc.amount" placeholder="0">
                    </div>
                    <button class="btn btn-primary" @click="createDoc()">Utw√≥rz dokument</button>
                </div>
            </div>
        </template>

        <!-- Describe View -->
        <template x-if="view=='describe'">
            <div x-init="load(); loadCategories()">
                <div class="header">
                    <h1 class="title">Opis i kategoryzacja</h1>
                </div>

                <div class="card" x-show="documents.filter(d=>d.status=='created').length">
                    <h3 style="margin-bottom:1rem">üìù Do opisania</h3>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Numer</th>
                                    <th>Kontrahent</th>
                                    <th>Kwota</th>
                                    <th>Kategoria</th>
                                    <th>Akcje</th>
                                </tr>
                            </thead>
                            <tbody>
                                <template x-for="doc in documents.filter(d=>d.status=='created')" :key="doc.id">
                                    <tr>
                                        <td x-text="doc.number"></td>
                                        <td x-text="doc.contractor"></td>
                                        <td x-text="doc.amount + ' PLN'"></td>
                                        <td>
                                            <select class="form-input" style="width:auto;padding:4px 8px" :value="doc.category || ''" @change="categorizeDoc(doc.id, $event.target.value)">
                                                <option value="">-- wybierz --</option>
                                                <template x-for="cat in categories" :key="cat.id">
                                                    <option :value="cat.id" x-text="cat.name"></option>
                                                </template>
                                            </select>
                                        </td>
                                        <td>
                                            <button class="btn btn-sm btn-secondary" @click="suggestCategory(doc.id)" title="Sugeruj kategoriƒô">üí°</button>
                                            <button class="btn btn-sm btn-primary" @click="showDescribeModal(doc)">Opisz</button>
                                        </td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="card" x-show="!documents.filter(d=>d.status=='created').length">
                    <div class="empty">Wszystko opisane ‚úì</div>
                </div>
            </div>
        </template>

        <!-- Upload View -->
        <template x-if="view=='upload'">
            <div>
                <div class="header">
                    <h1 class="title">Wgraj plik</h1>
                </div>
                <div class="card" style="max-width:600px">
                    <p style="margin-bottom:1rem;color:var(--muted)">Wgraj fakturƒô PDF lub zdjƒôcie. System automatycznie rozpozna dane za pomocƒÖ OCR.</p>
                    <div
                        style="border:2px dashed var(--border);border-radius:12px;padding:3rem;text-align:center;cursor:pointer;transition:all 0.2s"
                        @click="$refs.fileInput.click()"
                        @dragover.prevent="$event.target.style.borderColor='var(--accent)'"
                        @dragleave.prevent="$event.target.style.borderColor='var(--border)'"
                        @drop.prevent="handleFileDrop($event)"
                    >
                        <div style="font-size:3rem;margin-bottom:1rem">üìÑ</div>
                        <div style="font-size:1.1rem;font-weight:500;margin-bottom:0.5rem">PrzeciƒÖgnij plik tutaj</div>
                        <div style="color:var(--muted)">lub kliknij aby wybraƒá</div>
                        <div style="margin-top:1rem;font-size:0.85rem;color:var(--muted)">Obs≈Çugiwane: PDF, JPG, PNG</div>
                    </div>
                    <input type="file" x-ref="fileInput" @change="uploadFile($event)" accept=".pdf,.jpg,.jpeg,.png" style="display:none">

                    <div x-show="uploadProgress" style="margin-top:1rem">
                        <div style="background:var(--bg3);border-radius:8px;height:8px;overflow:hidden">
                            <div style="background:linear-gradient(90deg,var(--accent),#a29bfe);height:100%;transition:width 0.3s" :style="{width:uploadProgress+'%'}"></div>
                        </div>
                        <div style="text-align:center;margin-top:0.5rem;color:var(--muted)" x-text="uploadProgress < 100 ? 'Przetwarzanie...' : 'Gotowe!'">
                        </div>
                    </div>

                    <div x-show="lastUpload" style="margin-top:1.5rem;padding:1rem;background:rgba(0,212,170,0.08);border-radius:8px;border:1px solid rgba(0,212,170,0.35)">
                        <div style="font-weight:500;color:var(--accent);margin-bottom:0.5rem">‚úì Plik przetworzony</div>
                        <div style="font-size:0.9rem">
                            <div><strong>Numer:</strong> <span x-text="lastUpload?.number || '-'"></span></div>
                            <div><strong>Kwota:</strong> <span x-text="(lastUpload?.amount || 0) + ' PLN'"></span></div>
                            <div><strong>Pewno≈õƒá OCR:</strong> <span x-text="(lastUpload?.ocr_confidence || 0) + '%'"></span></div>
                        </div>
                        <button class="btn btn-secondary btn-sm" style="margin-top:0.5rem" @click="navigate('docs')">Zobacz dokumenty</button>
                    </div>
                </div>
            </div>
        </template>

        <template x-if="view=='import'" x-init="load()">
            <div>
                <div class="header">
                    <h1 class="title">Import</h1>
                    <button class="btn btn-primary" @click="createEndpointPrompt('import')">+ Dodaj ≈∫r√≥d≈Ço</button>
                </div>
                <div class="cards">
                    <template x-for="ep in (endpoints || []).filter(e => e.direction == 'import')" :key="ep.id">
                        <div class="card">
                            <div class="card-header">
                                <div class="card-icon" style="background:linear-gradient(135deg,#74b9ff,#0984e3)" x-text="ep.type=='ksef'?'üîê':ep.type=='email'?'üìß':'üì•'"></div>
                                <button class="btn btn-sm btn-danger" @click="deleteEndpoint(ep.id)">üóë</button>
                            </div>
                            <div class="card-title" x-text="ep.name"></div>
                            <div class="card-desc" x-text="ep.type"></div>
                            <div class="card-footer">
                                <button class="btn btn-secondary btn-sm" @click="pullEndpoint(ep.id)">Pobierz</button>
                            </div>
                        </div>
                    </template>
                </div>
                <div class="empty" x-show="!(endpoints || []).filter(e => e.direction == 'import').length">Brak ≈∫r√≥de≈Ç importu</div>
            </div>
        </template>

        <template x-if="view=='export'" x-init="load()">
            <div>
                <div class="header">
                    <h1 class="title">Export</h1>
                    <button class="btn btn-primary" @click="createEndpointPrompt('export')">+ Dodaj cel</button>
                </div>
                <div class="cards">
                    <template x-for="ep in (endpoints || []).filter(e => e.direction == 'export')" :key="ep.id">
                        <div class="card">
                            <div class="card-header">
                                <div class="card-icon" style="background:linear-gradient(135deg,#fdcb6e,#f39c12)" x-text="ep.type=='ksef'?'üîê':ep.type=='wfirma'?'üìä':'üì§'"></div>
                                <button class="btn btn-sm btn-danger" @click="deleteEndpoint(ep.id)">üóë</button>
                            </div>
                            <div class="card-title" x-text="ep.name"></div>
                            <div class="card-desc" x-text="ep.type"></div>
                            <div class="card-footer">
                                <button class="btn btn-secondary btn-sm" @click="pushEndpoint(ep.id)">Eksportuj</button>
                            </div>
                        </div>
                    </template>
                </div>
                <div class="empty" x-show="!(endpoints || []).filter(e => e.direction == 'export').length">Brak cel√≥w eksportu</div>
            </div>
        </template>

        <template x-if="view=='exportfile'" x-init="load()">
            <div>
                <div class="header">
                    <h1 class="title">Eksport do pliku</h1>
                </div>
                <div class="cards">
                    <div class="card" style="cursor:pointer" @click="exportToFormat('wfirma')">
                        <div class="card-header"><div class="card-icon" style="background:linear-gradient(135deg,#fdcb6e,#f39c12)">üìä</div></div>
                        <div class="card-title">wFirma CSV</div>
                        <div class="card-desc">Format KPiR dla wFirma.pl</div>
                    </div>
                    <div class="card" style="cursor:pointer" @click="exportToFormat('jpk_pkpir')">
                        <div class="card-header"><div class="card-icon" style="background:linear-gradient(135deg,#e17055,#d63031)">üìÑ</div></div>
                        <div class="card-title">JPK_PKPIR</div>
                        <div class="card-desc">Jednolity Plik Kontrolny XML</div>
                    </div>
                    <div class="card" style="cursor:pointer" @click="exportToFormat('comarch')">
                        <div class="card-header"><div class="card-icon" style="background:linear-gradient(135deg,#00b894,#00cec9)">üè¢</div></div>
                        <div class="card-title">Comarch Optima</div>
                        <div class="card-desc">Import XML do Comarch ERP</div>
                    </div>
                    <div class="card" style="cursor:pointer" @click="exportToFormat('symfonia')">
                        <div class="card-header"><div class="card-icon" style="background:linear-gradient(135deg,#6c5ce7,#a29bfe)">üéµ</div></div>
                        <div class="card-title">Symfonia</div>
                        <div class="card-desc">Format CSV dla Symfonia</div>
                    </div>
                    <div class="card" style="cursor:pointer" @click="exportToFormat('enova')">
                        <div class="card-header"><div class="card-icon" style="background:linear-gradient(135deg,#74b9ff,#0984e3)">üíº</div></div>
                        <div class="card-title">enova365</div>
                        <div class="card-desc">Format XML dla enova</div>
                    </div>
                </div>

                <div class="card" style="margin-top:16px" x-show="exportResult">
                    <div style="display:flex;justify-content:space-between;align-items:center">
                        <div>
                            <div class="card-title">Wynik eksportu</div>
                            <div class="card-desc" x-text="exportResult?.filename || ''"></div>
                        </div>
                        <button class="btn btn-primary" @click="downloadExport()" x-show="exportResult?.content">Pobierz</button>
                    </div>
                </div>
            </div>
        </template>

        <template x-if="view=='doc'" x-init="load()">
            <div>
                <div class="header">
                    <h1 class="title">Szczeg√≥≈Çy dokumentu</h1>
                    <button class="btn btn-secondary" @click="navigate('docs')">‚Üê Dokumenty</button>
                </div>

                <template x-if="currentDoc">
                    <div class="card">
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Numer</label>
                                <div x-text="currentDoc.number"></div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Status</label>
                                <div><span class="status" :class="'status-'+currentDoc.status" x-text="currentDoc.status"></span></div>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Kontrahent</label>
                                <div x-text="currentDoc.contractor || '-' "></div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Kwota</label>
                                <div x-text="(currentDoc.amount || 0) + ' PLN'"></div>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">VAT</label>
                                <div x-text="currentDoc.vat_rate || '-' "></div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Kategoria</label>
                                <div x-text="currentDoc.category || '-' "></div>
                            </div>
                        </div>

                        <div style="margin-top:16px;display:flex;gap:8px">
                            <button class="btn btn-secondary" @click="navigate('describe')" x-show="currentDoc.status=='created'">Opisz</button>
                            <button class="btn btn-secondary" @click="updateDocStatus(currentDoc.id,'described')" x-show="currentDoc.status=='created'">Ustaw jako opisany</button>
                            <button class="btn btn-danger" @click="deleteDoc(currentDoc.id)">Usu≈Ñ</button>
                        </div>
                    </div>
                </template>

                <div class="card" x-show="!currentDoc">
                    <div class="empty">Nie znaleziono dokumentu</div>
                </div>
            </div>
        </template>

        <!-- Signature View -->
        <template x-if="view=='sign'" x-data="SignatureManager()" x-init="init(profileId)">
            <div>
                <div class="header">
                    <h1 class="title">üîê Podpis Elektroniczny</h1>
                    <div style="display:flex;gap:12px;align-items:center">
                        <select class="form-input" style="width:200px" x-model="currentProvider">
                            <template x-for="provider in providers" :key="provider.value">
                                <option :value="provider.value" x-text="provider.label"></option>
                            </template>
                        </select>
                        <button class="btn btn-secondary" @click="loadCertificates()">üîÑ Od≈õwie≈º certyfikaty</button>
                    </div>
                </div>

                <!-- Provider Info -->
                <div class="card" style="margin-bottom:16px">
                    <h3 style="margin-bottom:8px">‚ÑπÔ∏è Dostawca podpisu</h3>
                    <div x-text="providers.find(p => p.value === currentProvider)?.description"></div>
                </div>

                <!-- Certificates -->
                <div class="card" style="margin-bottom:16px">
                    <h3 style="margin-bottom:12px">üìú Dostƒôpne certyfikaty</h3>
                    <template x-if="certificates.length">
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>W≈Ça≈õciciel</th>
                                        <th>Wa≈ºny od</th>
                                        <th>Wa≈ºny do</th>
                                        <th>Typ</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <template x-for="cert in certificates" :key="cert.id">
                                        <tr>
                                            <td x-text="cert.subject"></td>
                                            <td x-text="new Date(cert.valid_from).toLocaleDateString()"></td>
                                            <td x-text="new Date(cert.valid_to).toLocaleDateString()"></td>
                                            <td>
                                                <span class="badge" x-text="cert.type"></span>
                                            </td>
                                            <td>
                                                <span class="status status-signed">Aktywny</span>
                                            </td>
                                        </tr>
                                    </template>
                                </tbody>
                            </table>
                        </div>
                    </template>
                    <template x-if="!certificates.length">
                        <div class="empty">Brak dostƒôpnych certyfikat√≥w</div>
                    </template>
                </div>

                <!-- Signature Configuration -->
                <div class="card" style="margin-bottom:16px">
                    <h3 style="margin-bottom:12px">‚öôÔ∏è Konfiguracja podpisu</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Typ podpisu</label>
                            <select class="form-input" x-model="signatureConfig.type">
                                <option value="QES">Podpis kwalifikowany (osoba)</option>
                                <option value="QSEAL">Pieczƒôƒá kwalifikowana (firma)</option>
                                <option value="ADVANCED">Podpis zaawansowany</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Format</label>
                            <select class="form-input" x-model="signatureConfig.format">
                                <option value="PADES">PAdES (PDF)</option>
                                <option value="XADES">XAdES (XML/KSeF)</option>
                                <option value="CADES">CAdES (CMS)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Poziom</label>
                            <select class="form-input" x-model="signatureConfig.level">
                                <option value="T">Timestamp (z czasem)</option>
                                <option value="B">Basic</option>
                                <option value="LT">Long-Term</option>
                                <option value="LTA">Long-Term Archival</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Documents to Sign -->
                <div class="card" style="margin-bottom:16px">
                    <h3 style="margin-bottom:12px">üìÑ Dokumenty do podpisu</h3>
                    <div style="margin-bottom:12px">
                        <button class="btn btn-primary" @click="navigate('docs')" x-show="selectedDocuments.size === 0">
                            Wybierz dokumenty
                        </button>
                        <template x-if="selectedDocuments.size > 0">
                            <div style="display:flex;justify-content:space-between;align-items:center">
                                <span x-text="`Wybrano: ${selectedDocuments.size} dokument√≥w`"></span>
                                <button class="btn btn-primary" @click="signDocuments()" :disabled="signingInProgress">
                                    <span x-show="!signingInProgress">‚úçÔ∏è Podpisz wybrane</span>
                                    <span x-show="signingInProgress">‚è≥ Podpisywanie...</span>
                                </button>
                            </div>
                        </template>
                    </div>
                    
                    <!-- Signing Results -->
                    <template x-if="signingResults.length">
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Dokument</th>
                                        <th>Status</th>
                                        <th>ID podpisu</th>
                                        <th>Podpisany przez</th>
                                        <th>Data</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <template x-for="result in signingResults" :key="result.document_id">
                                        <tr>
                                            <td x-text="result.document_id"></td>
                                            <td>
                                                <span class="status" :class="result.success ? 'status-signed' : 'status-created'" 
                                                      x-text="result.success ? 'Podpisany' : 'B≈ÇƒÖd'"></span>
                                            </td>
                                            <td x-text="result.signature_id || '-'"></td>
                                            <td x-text="result.signer?.name || '-'"></td>
                                            <td x-text="result.timestamp ? new Date(result.timestamp).toLocaleString() : '-'"></td>
                                        </tr>
                                    </template>
                                </tbody>
                            </table>
                        </div>
                    </template>
                </div>

                <!-- Verify Section -->
                <div class="card">
                    <h3 style="margin-bottom:12px">üîç Weryfikacja podpisu</h3>
                    <div class="form-group">
                        <label class="form-label">Wybierz dokument do weryfikacji</label>
                        <select class="form-input" x-model="verifyDocumentId">
                            <option value="">-- Wybierz --</option>
                            <!-- Options would be populated from documents with signatures -->
                        </select>
                    </div>
                    <div style="display:flex;gap:8px">
                        <button class="btn btn-primary" @click="verifySignature(verifyDocumentId)" :disabled="!verifyDocumentId">
                            üîç Weryfikuj
                        </button>
                        <button class="btn btn-secondary" @click="verifyResult = null" x-show="verifyResult">
                            Wyczy≈õƒá wynik
                        </button>
                    </div>
                    
                    <template x-if="verifyResult">
                        <div style="margin-top:16px;padding:16px;background:var(--bg3);border-radius:6px">
                            <h4 style="margin-bottom:8px">Wynik weryfikacji:</h4>
                            <div style="display:grid;gap:8px">
                                <div><strong>Wa≈ºno≈õƒá:</strong> <span :class="verifyResult.valid ? 'status-signed' : 'status-created'" x-text="verifyResult.valid ? 'Wa≈ºny' : 'Niewa≈ºny'"></span></div>
                                <template x-if="verifyResult.signatures?.length">
                                    <div><strong>Podpisy:</strong></div>
                                    <template x-for="sig in verifyResult.signatures" :key="sig.certificate">
                                        <div style="margin-left:20px">
                                            - <span x-text="sig.signer"></span> (wa≈ºny do <span x-text="new Date(sig.valid_to).toLocaleDateString()"></span>)
                                        </div>
                                    </template>
                                </template>
                                <template x-if="verifyResult.timestamps?.length">
                                    <div><strong>Znaczniki czasu:</strong> <span x-text="verifyResult.timestamps.length"></span></div>
                                </template>
                            </div>
                        </div>
                    </template>
                </div>
            </div>
        </template>

        <div x-show="describeModal.show" @click.self="describeModal.show = false" x-cloak style="position:fixed;inset:0;background:rgba(0,0,0,0.7);display:flex;align-items:center;justify-content:center;z-index:300">
            <div class="card" style="max-width:600px;width:calc(100% - 32px)">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
                    <h3>Opis dokumentu</h3>
                    <button class="btn btn-sm" @click="describeModal.show = false">‚úï</button>
                </div>
                <div style="margin-bottom:1rem">
                    <strong>Dokument:</strong> <span x-text="describeModal.doc?.number"></span><br>
                    <strong>Kontrahent:</strong> <span x-text="describeModal.doc?.contractor"></span><br>
                    <strong>Kwota:</strong> <span x-text="(describeModal.doc?.amount || 0) + ' PLN'"></span>
                </div>
                <label style="display:block;margin-bottom:0.5rem;font-weight:500">Opis:</label>
                <textarea
                    id="describe-textarea"
                    class="form-input"
                    x-model="describeModal.comment"
                    @input="autoResizeTextarea($event)"
                    placeholder="Wprowad≈∫ opis dokumentu..."
                    style="min-height:80px;resize:none;overflow:hidden;line-height:1.5"
                ></textarea>
                <div style="margin-top:12px;display:flex;gap:8px;justify-content:flex-end">
                    <button class="btn btn-secondary" @click="describeModal.show = false">Anuluj</button>
                    <button class="btn btn-primary" @click="saveDescription()">Zapisz i zamknij</button>
                </div>
            </div>
        </div>

            </main>
</div>

<!-- Toast -->
<div class="toast" x-show="toast" x-text="toast" x-transition x-init="$watch('toast',v=>{if(v)setTimeout(()=>toast='',3000)})"></div>

<!-- Scripts -->
<script src="router.js"></script>
<script src="components/profile-manager.js"></script>
<script src="components/document-manager.js"></script>
<script src="components/signature-manager.js"></script>
<script>
    function app() {
        return {
            view: new URLSearchParams(window.location.search).get('view') || 'profiles',
            docId: new URLSearchParams(window.location.search).get('id'),
            profileId: localStorage.getItem('exef_profile') || 'default',
            profileOpen: false,
            profiles: [],
            documents: [],
            endpoints: [],
            stats: {},
            toast: '',
            newDoc: null,
            uploadProgress: 0,
            lastUpload: null,
            describeModal: { show: false, doc: null, comment: '' },
            categories: [],
            exportResult: null,

            get currentProfile() { 
                return this.profiles.find(p => p.id === this.profileId) 
            },

            get API() {
                return `/api/profiles/${this.profileId}`;
            },

            get currentDoc() {
                if (!this.docId) return null;
                return (this.documents || []).find(d => d.id === this.docId) || null;
            },
            
            async init() {
                console.log('App init - view:', this.view, 'profileId:', this.profileId);
                window.appInstance = this;
                await this.loadProfiles();
                this.restoreFromURL();
                window.addEventListener('popstate', () => this.restoreFromURL());
                await this.load();
                this.connectWS();
                
                // Listen for toast events
                window.addEventListener('toast', (e) => {
                    this.toast = e.detail;
                });
            },
            
            navigate(view, params = {}) {
                console.log('Navigate to:', view, 'params:', params);
                this.view = view;
                this.docId = params.id || null;
                this.updateURL();
            },
            
            updateURL() {
                const url = new URL(window.location);
                url.searchParams.set('view', this.view);
                url.searchParams.set('profile', this.profileId);
                if (this.docId) {
                    url.searchParams.set('id', this.docId);
                } else {
                    url.searchParams.delete('id');
                }
                window.history.pushState({view: this.view, profile: this.profileId, id: this.docId}, '', url);
            },
            
            restoreFromURL() {
                const params = new URLSearchParams(window.location.search);
                const view = params.get('view');
                const profile = params.get('profile');
                const id = params.get('id');
                
                console.log('Restore from URL - view:', view, 'profile:', profile, 'id:', id);
                
                if (view) this.view = view;
                if (id) this.docId = id;
                if (profile) {
                    this.profileId = profile;
                }
                
                console.log('After restore - current view:', this.view, 'profileId:', this.profileId);
            },
            
            async loadProfiles() {
                const response = await fetch('/api/profiles');
                this.profiles = await response.json();
                if (!this.profiles.find(p => p.id === this.profileId)) {
                    this.profileId = this.profiles[0]?.id || 'default';
                }
            },
            
            async load() {
                try {
                    const [docs, eps, stats] = await Promise.all([
                        fetch(`/api/profiles/${this.profileId}/documents`).then(r => r.ok ? r.json() : []),
                        fetch(`/api/profiles/${this.profileId}/endpoints`).then(r => r.ok ? r.json() : []),
                        fetch(`/api/profiles/${this.profileId}/stats`).then(r => r.ok ? r.json() : {})
                    ]);
                    this.documents = docs;
                    this.endpoints = eps;
                    this.stats = stats;
                } catch (e) {
                    console.error('Load error:', e);
                }
            },
            
            async switchProfile(id) {
                this.profileId = id;
                this.profileOpen = false;
                this.updateURL();
                await this.load();
                this.reconnectWS();
            },
            
            connectWS() {
                const proto = location.protocol === 'https:' ? 'wss:' : 'ws:';
                this.ws = new WebSocket(`${proto}//${location.host}/ws/${this.profileId}`);
                this.ws.onmessage = (e) => { this.toast = JSON.parse(e.data).event; this.load(); };
                this.ws.onclose = () => setTimeout(() => this.connectWS(), 2000);
            },
            
            reconnectWS() {
                if (this.ws) this.ws.close();
                this.connectWS();
            },

            ensureNewDoc() {
                if (!this.newDoc) {
                    this.newDoc = {type:'invoice',number:'',contractor:'',amount:0,vat_rate:'23%'};
                }
            },

            showToast(message) {
                window.dispatchEvent(new CustomEvent('toast', { detail: message }));
            },

            async createDoc() {
                this.ensureNewDoc();
                try {
                    const r = await fetch(this.API + '/documents', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(this.newDoc)
                    });
                    if (!r.ok) {
                        this.showToast('B≈ÇƒÖd tworzenia dokumentu');
                        return;
                    }
                    this.newDoc = {type:'invoice',number:'',contractor:'',amount:0,vat_rate:'23%'};
                    this.showToast('Dokument utworzony');
                    await this.load();
                    this.navigate('docs');
                } catch (e) {
                    console.error('Create doc failed:', e);
                    this.showToast('B≈ÇƒÖd po≈ÇƒÖczenia');
                }
            },

            async loadCategories() {
                try {
                    const r = await fetch('/api/categories');
                    if (!r.ok) return;
                    const data = await r.json();
                    const cats = data?.categories || {};
                    this.categories = Object.entries(cats).map(([id, cfg]) => ({
                        id,
                        name: cfg?.name || id
                    }));
                } catch (e) {
                    console.error('Load categories failed:', e);
                }
            },

            async categorizeDoc(id, category) {
                try {
                    const r = await fetch(this.API + '/documents/' + id + '/categorize', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ category })
                    });
                    if (r.ok) {
                        this.showToast('Kategoria zapisana');
                        await this.load();
                    } else {
                        this.showToast('B≈ÇƒÖd zapisu kategorii');
                    }
                } catch (e) {
                    console.error('Categorize failed:', e);
                    this.showToast('B≈ÇƒÖd po≈ÇƒÖczenia');
                }
            },

            async suggestCategory(id) {
                try {
                    const r = await fetch(this.API + '/documents/' + id + '/suggest', { method: 'POST' });
                    const data = r.ok ? await r.json() : null;
                    if (data?.category) {
                        await this.categorizeDoc(id, data.category);
                        this.showToast(`Sugestia: ${data.category_name} (${data.confidence}%)`);
                    } else {
                        this.showToast('Brak sugestii kategorii');
                    }
                } catch (e) {
                    console.error('Suggest failed:', e);
                    this.showToast('B≈ÇƒÖd po≈ÇƒÖczenia');
                }
            },

            showDescribeModal(doc) {
                this.describeModal.doc = doc;
                this.describeModal.comment = doc?.description || '';
                this.describeModal.show = true;
                this.$nextTick(() => {
                    const textarea = document.querySelector('#describe-textarea');
                    if (textarea) {
                        textarea.focus();
                        textarea.style.height = 'auto';
                        textarea.style.height = textarea.scrollHeight + 'px';
                    }
                });
            },

            async saveDescription() {
                const doc = this.describeModal?.doc;
                if (!doc?.id) return;
                try {
                    const r = await fetch(this.API + '/documents/' + doc.id, {
                        method: 'PATCH',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            description: this.describeModal.comment,
                            status: 'described'
                        })
                    });
                    if (r.ok) {
                        this.showToast('Opis zapisany');
                        this.describeModal.show = false;
                        await this.load();
                    } else {
                        this.showToast('B≈ÇƒÖd zapisu opisu');
                    }
                } catch (e) {
                    console.error('Save description failed:', e);
                    this.showToast('B≈ÇƒÖd po≈ÇƒÖczenia');
                }
            },

            autoResizeTextarea(event) {
                event.target.style.height = 'auto';
                event.target.style.height = event.target.scrollHeight + 'px';
            },

            async uploadFile(event) {
                const file = event.target.files[0];
                if (!file) return;
                await this.doUpload(file);
            },

            handleFileDrop(event) {
                const file = event.dataTransfer.files[0];
                if (!file) return;
                this.doUpload(file);
            },

            async doUpload(file) {
                this.uploadProgress = 10;
                this.lastUpload = null;

                const formData = new FormData();
                formData.append('file', file);

                this.uploadProgress = 30;

                try {
                    const r = await fetch(this.API + '/upload', {
                        method: 'POST',
                        body: formData
                    });

                    this.uploadProgress = 80;

                    if (r.ok) {
                        this.lastUpload = await r.json();
                        this.showToast('Plik przetworzony pomy≈õlnie');
                        await this.load();
                    } else {
                        this.showToast('B≈ÇƒÖd przesy≈Çania pliku');
                    }
                } catch (e) {
                    console.error('Upload failed:', e);
                    this.showToast('B≈ÇƒÖd po≈ÇƒÖczenia');
                }

                this.uploadProgress = 100;
                setTimeout(() => { this.uploadProgress = 0; }, 2000);
            },

            async deleteEndpoint(id) {
                try {
                    const r = await fetch(this.API + '/endpoints/' + id, { method: 'DELETE' });
                    if (r.ok) {
                        this.showToast('Endpoint usuniƒôty');
                        await this.load();
                    } else {
                        this.showToast('B≈ÇƒÖd usuwania endpointu');
                    }
                } catch (e) {
                    console.error('Delete endpoint failed:', e);
                    this.showToast('B≈ÇƒÖd po≈ÇƒÖczenia');
                }
            },

            async pullEndpoint(id) {
                try {
                    this.showToast('Pobieranie...');
                    const r = await fetch(this.API + '/flow/pull/' + id, { method: 'POST' });
                    const data = r.ok ? await r.json() : null;
                    if (data?.imported !== undefined) {
                        this.showToast(`Zaimportowano ${data.imported} dok.`);
                    } else {
                        this.showToast('B≈ÇƒÖd importu');
                    }
                    await this.load();
                } catch (e) {
                    console.error('Pull failed:', e);
                    this.showToast('B≈ÇƒÖd po≈ÇƒÖczenia');
                }
            },

            async pushEndpoint(id) {
                try {
                    const docs = (this.documents || []).filter(d => d.status === 'signed').map(d => d.id);
                    if (!docs.length) {
                        this.showToast('Brak dokument√≥w do eksportu');
                        return;
                    }
                    const r = await fetch(this.API + '/flow/push/' + id, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(docs)
                    });
                    const data = r.ok ? await r.json() : null;
                    if (data?.success) {
                        this.showToast(`Wyeksportowano ${data.exported} dok.`);
                    } else {
                        this.showToast('B≈ÇƒÖd eksportu');
                    }
                    await this.load();
                } catch (e) {
                    console.error('Push failed:', e);
                    this.showToast('B≈ÇƒÖd po≈ÇƒÖczenia');
                }
            },

            async createEndpointPrompt(direction) {
                const name = window.prompt(direction === 'import' ? 'Nazwa ≈∫r√≥d≈Ça importu:' : 'Nazwa celu eksportu:');
                if (!name) return;

                let type = 'email';
                if (direction === 'export') type = 'wfirma';

                try {
                    const r = await fetch(this.API + '/endpoints', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            direction,
                            type,
                            name,
                            config: {}
                        })
                    });
                    if (r.ok) {
                        this.showToast('Endpoint dodany');
                        await this.load();
                    } else {
                        this.showToast('B≈ÇƒÖd dodawania endpointu');
                    }
                } catch (e) {
                    console.error('Create endpoint failed:', e);
                    this.showToast('B≈ÇƒÖd po≈ÇƒÖczenia');
                }
            },

            async updateDocStatus(id, status) {
                try {
                    const r = await fetch(this.API + '/documents/' + id, {
                        method: 'PATCH',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ status })
                    });
                    if (r.ok) {
                        this.showToast('Status zaktualizowany');
                        await this.load();
                    } else {
                        this.showToast('B≈ÇƒÖd zmiany statusu');
                    }
                } catch (e) {
                    console.error('Update status failed:', e);
                    this.showToast('B≈ÇƒÖd po≈ÇƒÖczenia');
                }
            },

            async deleteDoc(id) {
                if (!window.confirm('UsunƒÖƒá dokument?')) return;
                try {
                    const r = await fetch(this.API + '/documents/' + id, { method: 'DELETE' });
                    if (r.ok) {
                        this.showToast('Dokument usuniƒôty');
                        await this.load();
                        this.navigate('docs');
                    } else {
                        this.showToast('B≈ÇƒÖd usuwania dokumentu');
                    }
                } catch (e) {
                    console.error('Delete doc failed:', e);
                    this.showToast('B≈ÇƒÖd po≈ÇƒÖczenia');
                }
            },

            async exportToFormat(format) {
                try {
                    this.showToast('Eksportowanie...');
                    const signedDocs = (this.documents || []).filter(d => d.status === 'signed' || d.status === 'exported');
                    if (!signedDocs.length) {
                        this.showToast('Brak podpisanych dokument√≥w do eksportu');
                        return;
                    }
                    const r = await fetch(this.API + '/export/' + format, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ document_ids: signedDocs.map(d => d.id) })
                    });
                    if (r.ok) {
                        this.exportResult = await r.json();
                        this.showToast(`Wyeksportowano ${this.exportResult.count} dokument√≥w`);
                    } else {
                        this.showToast('B≈ÇƒÖd eksportu');
                    }
                } catch (e) {
                    console.error('Export failed:', e);
                    this.showToast('B≈ÇƒÖd po≈ÇƒÖczenia');
                }
            },

            downloadExport() {
                if (!this.exportResult?.content) return;
                const blob = new Blob([this.exportResult.content], {type: 'text/plain;charset=utf-8'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = this.exportResult.filename || 'export.txt';
                a.click();
                URL.revokeObjectURL(url);
            },
            
            viewTitle(view) {
                const titles = {
                    'docs': 'Dokumenty',
                    'create': 'Utw√≥rz dokument',
                    'describe': 'Opis i kategoryzacja',
                    'sign': 'Podpis dokument√≥w',
                    'upload': 'Wgraj plik',
                    'import': 'Import',
                    'export': 'Export',
                    'exportfile': 'Eksport do pliku'
                };
                return titles[view] || view;
            }
        };
    }
    
    // Initialize global app instance
    document.addEventListener('alpine:init', () => {
        window.appInstance = Alpine.data('app', app);
    });
</script>
</body>
</html>
