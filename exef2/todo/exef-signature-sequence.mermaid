%%{init: {'theme': 'base', 'themeVariables': { 'actorTextColor': '#333', 'actorBkg': '#e3f2fd', 'signalColor': '#1a73e8'}}}%%

sequenceDiagram
    autonumber
    participant U as ðŸ‘¤ UÅ¼ytkownik
    participant EXEF as ðŸ–¥ï¸ EXEF Desktop
    participant SIG as âœï¸ Signature Adapter
    participant MSZAFIR as â˜ï¸ mSzafir API
    participant APP as ðŸ“± Aplikacja mobilna
    participant KSEF as ðŸ“‹ KSeF

    Note over U,KSEF: ðŸ” Scenariusz 1: Podpis kwalifikowany przez mSzafir

    U->>EXEF: Wybierz dokumenty do podpisu
    EXEF->>SIG: sign_documents(docs, "QES", "PAdES")
    SIG->>MSZAFIR: POST /signing/init
    MSZAFIR-->>SIG: sessionId + authorizationUrl
    SIG-->>EXEF: Wymaga autoryzacji w aplikacji
    EXEF-->>U: ðŸ“± PotwierdÅº w aplikacji mSzafir
    
    U->>APP: OtwÃ³rz powiadomienie push
    APP->>APP: WprowadÅº PIN
    APP->>MSZAFIR: authorize(sessionId)
    MSZAFIR-->>APP: âœ… Authorized
    
    loop Polling (max 30s)
        SIG->>MSZAFIR: GET /signing/status/{sessionId}
        MSZAFIR-->>SIG: status: pending / completed
    end
    
    MSZAFIR-->>SIG: signedDocument + signatureId
    SIG-->>EXEF: Dokumenty podpisane
    EXEF-->>U: âœ… Sukces! Podpisano 3 dokumenty

    Note over U,KSEF: ðŸ“‹ Scenariusz 2: WysyÅ‚ka do KSeF z pieczÄ™ciÄ…

    U->>EXEF: WyÅ›lij faktury do KSeF
    EXEF->>SIG: seal_documents(invoices, "QSEAL", "XAdES")
    Note right of SIG: PieczÄ™Ä‡ automatyczna<br/>(bez autoryzacji uÅ¼ytkownika)
    SIG->>MSZAFIR: POST /sealing/sign (auto)
    MSZAFIR-->>SIG: sealedDocuments
    SIG-->>EXEF: Faktury opieczÄ™towane
    
    EXEF->>KSEF: POST /api/v1/invoices/batch
    Note right of KSEF: Certyfikat MCU<br/>do autoryzacji
    KSEF-->>EXEF: ksef_ids[], status: accepted
    EXEF-->>U: âœ… WysÅ‚ano 10 faktur do KSeF

    Note over U,KSEF: ðŸ” Scenariusz 3: Weryfikacja podpisu

    U->>EXEF: Weryfikuj podpisany PDF
    EXEF->>SIG: verify(signedDocument)
    SIG->>MSZAFIR: POST /verification/verify
    MSZAFIR-->>SIG: valid: true, signatures: [...]
    SIG-->>EXEF: Raport weryfikacji
    EXEF-->>U: âœ… Podpis waÅ¼ny do 2027-01-15<br/>PodpisaÅ‚: Jan Kowalski<br/>Certyfikat: KIR mSzafir
